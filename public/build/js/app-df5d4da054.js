$(function(){function t(t){$(t).on("click",".disabled",function(){$("#ajax-status").text("已经没有了。"),$("#ajax-status").show(),$("#ajax-status").fadeOut(2e3)})}function e(t){$("html, body").animate({scrollTop:$(t).offset().top-100},1e3)}$("#ajax-status").click(function(){$(this).hide()}),$(".disabled").click(function(){$("#ajax-status").text("已经没有了。"),$("#ajax-status").show(),$("#ajax-status").fadeOut(2e3)}),$("#send").click(function(){var t=$("#content").val(),e=t.replace(/\ +/g,"");if(""==t||""==e)return $("#content").val("").attr("placeholder","老大，我很饿...."),!1;$("#message-form").submit()});var a=[];$(".get-comments").click(function(){var e=$(this).parent().next();e.is(":hidden")?e.show():e.hide();var s=$(this).parent().attr("data-id");-1==$.inArray(s,a)&&($.ajax({type:"get",url:"/article/get-comments/"+s,dataType:"json",success:function(e){var a="";return $(e.comments).each(function(t,e){a+='<div><span class="author"><i class="fa fa-user" aria-hidden="true"></i> 匿名用户 &nbsp;&nbsp;<i>'+e.Created_at+"</i></span><p>"+e.Comment+"</p><hr></div>"}),$("#"+e.id).prev().html(a),1==e.all_page?void $("#"+e.id).children("div").hide():1==e.current_page?($("#"+e.id).children("div").children("span").removeClass("disabled"),$("#"+e.id).children("div").children(".comment-prev").addClass("disabled"),void t($("#"+e.id).children("div"))):e.current_page==e.all_page?($("#"+e.id).children("div").children("span").removeClass("disabled"),$("#"+e.id).children("div").children(".comment-next").addClass("disabled"),void t($("#"+e.id).children("div"))):void 0},error:function(t){console.log(t)}}),a.push(s))}),$(".comment-next, .comment-prev").click(function(){if(!$(this).is(".disabled")){var a=$(this).parent().parent().attr("id"),s=$(this).parent().parent().data("currpage");if($(this).is(".comment-next"))var r=Number(s)+1;else var r=Number(s)-1;$.ajax({type:"get",url:"/article/get-comments/"+a+"?page="+r,dataType:"json",success:function(a){var s="";return $(a.comments).each(function(t,e){s+='<div><span class="author"><i class="fa fa-user" aria-hidden="true"></i> 匿名用户 &nbsp;&nbsp;<i>'+e.Created_at+"</i></span><p>"+e.Comment+"</p><hr></div>"}),$("#"+a.id).prev().html(s),1==a.all_page?void $("#"+a.id).children("div").hide():1==a.current_page?($("#"+a.id).children("div").children("span").removeClass("disabled"),$("#"+a.id).children("div").children("a").text(a.current_page),$("#"+a.id).data("currpage",a.current_page),$("#"+a.id).children("div").children(".comment-prev").addClass("disabled"),t($("#"+a.id).children("div")),void e($("#"+a.id).parent().parent())):a.current_page>=a.all_page?($("#"+a.id).children("div").children("span").removeClass("disabled"),$("#"+a.id).children("div").children("a").text(a.current_page),$("#"+a.id).data("currpage",a.current_page),$("#"+a.id).children("div").children(".comment-next").addClass("disabled"),t($("#"+a.id).children("div")),void e($("#"+a.id).parent().parent())):void 0},error:function(t){console.log(t)}})}}),$(".btn-comment").click(function(){var t=$(this).prev().val(),e=$(this).parent().attr("id"),a=t.replace(/\ +/g,"");if(""==t||""==a)return $(this).prev().val("").attr("placeholder","请写下你的评论"),!1;$.ajax({type:"post",url:"/article/add-comment",headers:{"X-CSRF-TOKEN":$("input[name=_csrf]").val()},dataType:"json",data:{comment:t,article_id:e},success:function(t){$("#"+t.id).children("input").val(""),$("#"+t.id).prev().append('<div><span class="author"><i class="fa fa-user" aria-hidden="true"></i> 匿名用户 &nbsp;&nbsp;<i>'+t.created_at+"</i></span><p>"+t.comment+"</p><hr></div>");var e=$("#"+t.id).parent().prev().find("i:last");e.text(Number(e.text())+1)},error:function(t){console.log(t)}})}),$("#form-register").validate({rules:{"昵称":{required:!0,minlength:4},"邮箱":{required:!0,email:!0},"密码":{required:!0,minlength:6},"密码确认":{required:!0,minlength:6,equalTo:"#re-password"}},messages:{"昵称":{required:"不能为空",minlength:"至少4个字符"},"邮箱":{required:"不能为空",email:"请填写正确的格式 如：name@domain.com"},"密码":{required:"不能为空",minlength:"至少6位"},"密码确认":{required:"不能为空",minlength:"至少6位",equalTo:"两次密码不相同"}}}),$("#login").mouseenter(function(){$("#user-dropdown").show()}).mouseleave(function(){$("#user-dropdown").hide()}),$("#btn-login").click(function(){var t=$("#email").val(),e=$("#password").val();return""==t?($(this).prev().addClass("text-danger bg-danger").text("邮箱不能为空"),!1):/^[\w\-\.]+@[\w\-\.]+(\.\w+)+$/.test(t)?""==e?($(this).prev().addClass("text-danger bg-danger").text("密码不能为空"),!1):e.length<6?($(this).prev().addClass("text-danger bg-danger").text("密码长度至少6位字符"),!1):($(this).prev().removeClass("text-danger bg-danger").html('<i class="fa fa-spinner fa-spin fa-2x" aria-hidden="true"></i> 登录中...'),void $.ajax({type:"post",url:"/login",headers:{"X-CSRF-TOKEN":$("input[name=_csrf]").val()},dataType:"json",data:{email:t,password:e},success:function(t){if(""!=t.error)return $("#btn-login").prev().addClass("text-danger bg-danger").text(t.error),!1;window.location.reload()},error:function(t){$("#btn-login").prev().addClass("text-danger bg-danger").text(t.statusText)}})):($(this).prev().addClass("text-danger bg-danger").text("邮箱格式不对，如：name@domain.com"),!1)}),$("#btn-set-name").click(function(){$.ajax({type:"post",url:"/auth/setting/name",headers:{"X-CSRF-TOKEN":$("input[name=_csrf]").val()},dataType:"json",data:{name:$("input[name=name]").val()},success:function(t){""!=t.error?$("#ajax-status2").html('            \t\t<div class="alert alert-danger">\t            \t\t<button type="button" class="close" data-dismiss="alert" aria-hidden="true">\t\t\t                &times;\t\t\t            </button>'+t.error+"</div>"):$("#ajax-status2").html('            \t\t<div class="alert alert-success">\t            \t\t<button type="button" class="close" data-dismiss="alert" aria-hidden="true">\t\t\t                &times;\t\t\t            </button>'+t.success+"</div>")},error:function(t){$("#ajax-status").text(t.statusText),$("#ajax-status").show(),$("#ajax-status").fadeOut(2e3)}})}),$("#btn-set-sex").click(function(){$.ajax({type:"post",url:"/auth/setting/sex",headers:{"X-CSRF-TOKEN":$("input[name=_csrf]").val()},dataType:"json",data:{sex:$("input[name=sex]:checked").val()},success:function(t){""!=t.error?$("#ajax-status2").html('            \t\t<div class="alert alert-danger">\t            \t\t<button type="button" class="close" data-dismiss="alert" aria-hidden="true">\t\t\t                &times;\t\t\t            </button>'+t.error+"</div>"):$("#ajax-status2").html('            \t\t<div class="alert alert-success">\t            \t\t<button type="button" class="close" data-dismiss="alert" aria-hidden="true">\t\t\t                &times;\t\t\t            </button>'+t.success+"</div>")},error:function(t){$("#ajax-status").text(t.statusText),$("#ajax-status").show(),$("#ajax-status").fadeOut(2e3)}})}),$("#btn-set-header").click(function(){$("#input-header").click()}),$("#input-header").change(function(){lrz(this.files[0],{width:44}).then(function(t){$("#ajax-status2").html('<i class="fa fa-spinner fa-spin fa-2x" aria-hidden="true"></i> 上传中...'),t.formData.append("base64img",t.base64),$.ajax({url:"/auth/setting/header",type:"POST",data:t.formData,headers:{"X-CSRF-TOKEN":$("input[name=_csrf]").val()},dataType:"json",processData:!1,contentType:!1,success:function(t){if(""!=t.error)return void alert(t.error);$("#img-header").attr("src",t.src),$("#img-base-header").css("background-image","url("+t.src+")"),$("#ajax-status2").html("")},error:function(t){alert(t.statusText)}})}).catch(function(t){alert(t)}).always(function(){})}),$("#btn-set-password").click(function(){var t=$("input[name=old-psd]").val(),e=$("input[name=new-psd]").val(),a=$("input[name=new-psd-confirm]").val();return""==t||""==e||""==a?($("#ajax-status2").html('            \t\t<div class="alert alert-danger">\t            \t\t<button type="button" class="close" data-dismiss="alert" aria-hidden="true">\t\t\t                &times;\t\t\t            </button>\t\t\t             密码不能为空            \t\t</div>'),!1):t.length<6||e.length<6||a<6?($("#ajax-status2").html('            \t\t<div class="alert alert-danger">\t            \t\t<button type="button" class="close" data-dismiss="alert" aria-hidden="true">\t\t\t                &times;\t\t\t            </button>\t\t\t             长度至少6位            \t\t</div>'),!1):e!=a?($("#ajax-status2").html('            \t\t<div class="alert alert-danger">\t            \t\t<button type="button" class="close" data-dismiss="alert" aria-hidden="true">\t\t\t                &times;\t\t\t            </button>\t\t\t             两次新密码不相同            \t\t</div>'),!1):void $.ajax({type:"post",url:"/auth/setting/password",headers:{"X-CSRF-TOKEN":$("input[name=_csrf]").val()},dataType:"json",data:{oldpsd:t,newpsd:e,newpsd_confirm:a},success:function(t){""!=t.error?$("#ajax-status2").html('            \t\t<div class="alert alert-danger">\t            \t\t<button type="button" class="close" data-dismiss="alert" aria-hidden="true">\t\t\t                &times;\t\t\t            </button>'+t.error+"</div>"):$("#ajax-status2").html('            \t\t<div class="alert alert-success">\t            \t\t<button type="button" class="close" data-dismiss="alert" aria-hidden="true">\t\t\t                &times;\t\t\t            </button>'+t.success+"</div>")},error:function(t){$("#ajax-status").text(t.statusText),$("#ajax-status").show(),$("#ajax-status").fadeOut(2e3)}})})}),$(".btn-thx").click(function(){var t=$(this).children("i:last-child"),e=$(this).parent().attr("data-id");t.text(Number(t.text())+1),$(this).unbind("click"),$.get("/article/add-thank/"+e)}),$("#img-base-header").click(function(){$("#user-dropdown").is(":hidden")?$("#user-dropdown").show():$("#user-dropdown").hide()});